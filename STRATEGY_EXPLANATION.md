# Объяснение стратегии xlWithSupport

## Анализ проблемы

При обработке строки из 337 событий иногда возникают огромные ставки и убытки (миллионы). Проблема проявляется не всегда, а только при определенных последовательностях событий.

## Как работает стратегия xlWithSupport (строки 220-426)

### 1. Основные переменные

```go
lossF, lossX, lossL  // Накопленные убытки по каждому исходу
uf, ux, ul           // Серии без выигрыша (сколько раз подряд не выпадал исход)
baseAmount = 5000    // Базовая сумма (config.DefaultBetF)
total                // Общая прибыль
```

### 2. Инициализация убытков (строки 238-246)

```go
if uf == 0 {  // Если F только что выиграл или это первое событие
    lossF = baseAmount  // убыток = 5000
}
if ux == 0 {  // Если X только что выиграл или это первое событие
    lossX = baseAmount  // убыток = 5000
}
if ul == 0 {  // Если L только что выиграл или это первое событие
    lossL = baseAmount  // убыток = 5000
}
```

### 3. Распределение убытков (строки 251-282)

Если хотя бы один исход давно не выпадал (uf > 0 или ux > 0 или ul > 0):

```go
ratio := 0.3
realLoss := lossF + lossX + lossL - baseAmount*3
// realLoss = сумма всех убытков минус планируемая прибыль (15000)
```

Затем убытки перераспределяются:
```go
lossF = baseAmount  // Сброс до 5000
lossX = baseAmount  // Сброс до 5000
lossL = baseAmount  // Сброс до 5000

if ux > 3 && ul > 3 {
    fullCoverage = "XL"  // Полное покрытие X и L
} else {
    smallPart := roundUp(ratio * realLoss)      // 30% от realLoss
    lossX += smallPart                          // X получает 30%
    lossL += roundUp(realLoss - smallPart)      // L получает 70%
    fullCoverage = "X"
    if lossL > baseAmount*2 {  // Если lossL > 10000
        partialCoverage = "L"
    }
}
```

### 4. Расчет ставок и СМЫСЛ ПОКРЫТИЯ (строки 284-308)

Сначала рассчитываются ставки на X и L:
```go
betX = calcBet(lossX, current.OddX, debug)
betL = calcBet(lossL, current.OddL, debug)
```

**СМЫСЛ ПОКРЫТИЯ:** Стратегия пытается "застраховать" ставку на F, добавляя к убыткам F суммы ставок на X и L. Это означает, что если выиграет F, он должен покрыть не только свои убытки, но и проигранные ставки на X и L.

```go
if fullCoverage == "XL" {
    lossF += betX + betL
    // F должен покрыть полные ставки на X и L
    // Это происходит когда и X, и L долго не выпадали (>3 раза)
    
} else if fullCoverage == "X" {
    lossF += betX
    // F всегда покрывает полную ставку на X
    
    if partialCoverage == "L" {
        lossF += betL - baseAmount*2
        // F покрывает ставку на L минус двойная базовая сумма (10000)
        // Частичное покрытие, так как L имеет большие убытки (>10000)
    }
    
} else if fullCoverage == "L" {
    lossF += betL
    // F покрывает полную ставку на L
    
    if partialCoverage == "X" {
        lossF += betX - baseAmount*2
        // F покрывает ставку на X минус двойная базовая сумма
        // Частичное покрытие
    }
}

betF = calcBet(lossF, current.OddF, debug)
// Теперь рассчитывается ставка на F с учетом всех покрытий
```

**ЛОГИКА ПОКРЫТИЯ:**
- Система старается, чтобы выигрыш F компенсировал не только его собственные убытки, но и проигранные ставки на другие исходы
- Частичное покрытие (минус baseAmount*2) используется для смягчения нагрузки на F
- Это создает взаимозависимость между ставками

### 5. Обработка результата (строки 329-407)

**Если выпал F (строки 330-366):**
```go
// Серии
uf = 0    // F выиграл, сброс серии
ux++      // X не выпал
ul++      // L не выпал

// Убытки
lossF = 0  // F выиграл, убытки обнулены

// СМЫСЛ: Проверяем, какие ставки были "покрыты" F
if fullCoverage == "XL" {
    lossX += 0  // X был полностью покрыт, убытки не растут
    lossL += 0  // L был полностью покрыт, убытки не растут
    
} else if fullCoverage == "X" {
    lossX += 0  // X был покрыт полностью
    
    if partialCoverage == "L" {
        lossL += betL - baseAmount*2  
        // L был покрыт частично, добавляем только непокрытую часть
    } else {
        lossL += betL  
        // L не был покрыт, добавляем полную ставку
    }
    
} else if fullCoverage == "L" {
    lossL += 0  // L был покрыт полностью
    
    if partialCoverage == "X" {
        lossX += betX - baseAmount*2  
        // X был покрыт частично
    } else {
        lossX += betX  
        // X не был покрыт
    }
    
} else {
    lossX += betX  // Не покрыт
    lossL += betL  // Не покрыт
}
```

**Если выпал X (строки 368-386):**
```go
// Простая логика - X выиграл, F и L проиграли
lossF += betF  // F проиграл свою ставку
lossX = 0      // X выиграл, убытки обнулены
lossL += betL  // L проиграл свою ставку
```

**Если выпал L (строки 388-407):**
```go
// Простая логика - L выиграл, F и X проиграли
lossF += betF  // F проиграл свою ставку
lossX += betX  // X проиграл свою ставку
lossL = 0      // L выиграл, убытки обнулены
```

### 6. Обновление total (строка 316)

```go
total += baseAmount  // Добавляем 5000 к прибыли
```